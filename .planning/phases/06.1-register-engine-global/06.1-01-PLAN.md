---
phase: 06.1-register-engine-global
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/Engine.cpp
autonomous: true

must_haves:
  truths:
    - "Lua scripts can access `engine` as a global variable"
    - "engine:getClock() returns Clock userdata"
    - "engine:getModuleRegistry() returns ModuleRegistry userdata"
  artifacts:
    - path: "src/core/Engine.cpp"
      provides: "Engine global registration in setupLua()"
      contains: "SWIG_NewPointerObj"
  key_links:
    - from: "src/core/Engine.cpp"
      to: "Lua state"
      via: "SWIG_NewPointerObj + lua_setglobal"
      pattern: "lua_setglobal.*engine"
---

<objective>
Register the `engine` global in Lua state to unblock ALL ScriptManager-generated scripts.

Purpose: ScriptManager generates scripts using `engine:getClock()`, `engine:getModuleRegistry()`, etc., but the `engine` global is never created. This is the CRITICAL blocker preventing any scripts from working.

Output: Modified Engine::setupLua() that creates the `engine` global using SWIG bindings.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-research-design-lua-engine-integration/06-DESIGN.md
@src/core/Engine.cpp
@src/core/lua/videoTracker.i
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add engine global registration to Engine::setupLua()</name>
  <files>src/core/Engine.cpp</files>
  <action>
In `Engine::setupLua()`, after line 295 (`lua_register(L, "exec", lua_execCommand);`), add the engine global registration:

```cpp
// CRITICAL: Create 'engine' global for ScriptManager-generated scripts
// This makes engine:* bindings available in all Lua scripts
SWIG_NewPointerObj(L, this, SWIGTYPE_p_vt__Engine, 0);
lua_setglobal(L, "engine");
```

Also update the log message on line 297 from:
```cpp
ofLogNotice("Engine") << "Lua initialized successfully - using SWIG bindings for helper functions";
```

To:
```cpp
ofLogNotice("Engine") << "Lua initialized with engine global - SWIG bindings available";
```

**Why this works:**
- `SWIG_NewPointerObj()` creates a Lua userdata wrapping the C++ Engine pointer
- `lua_setglobal()` assigns it to the global name "engine"
- `SWIGTYPE_p_vt__Engine` is the SWIG type descriptor for `vt::Engine*`
- The 0 flag means Lua doesn't own the pointer (Engine manages its own lifetime)

**Note:** The `registerEngineGlobal()` function in videoTracker.i does the same thing, but calling it from Engine.cpp would require including SWIG-generated headers. It's simpler to inline the 2 lines directly.
  </action>
  <verify>
1. Build succeeds: `make` in project root
2. Run app and check console for log message: "Lua initialized with engine global"
3. In Lua console, type: `print(type(engine))` - should print "userdata"
4. In Lua console, type: `print(engine:getClock())` - should print Clock userdata (not error)
  </verify>
  <done>
- `src/core/Engine.cpp` contains `SWIG_NewPointerObj(L, this, SWIGTYPE_p_vt__Engine, 0);`
- `src/core/Engine.cpp` contains `lua_setglobal(L, "engine");`
- Log message confirms engine global is registered
- Lua scripts can access `engine:*` methods without "nil value" error
  </done>
</task>

</tasks>

<verification>
After completing the task:

1. **Build verification:** Project compiles without errors
2. **Runtime verification:** App starts and console shows "Lua initialized with engine global"
3. **Lua verification:** Run in Lua console:
   ```lua
   if engine and type(engine) == "userdata" then
       print("SUCCESS: engine global available")
       print("Clock:", engine:getClock())
       print("ModuleRegistry:", engine:getModuleRegistry())
   else
       print("FAILED: engine is " .. tostring(engine))
   end
   ```
   Expected: All three print statements show userdata objects
</verification>

<success_criteria>
- Build passes
- App starts without crashes
- `engine` global exists in Lua as userdata
- `engine:getClock()` returns valid Clock object
- `engine:getModuleRegistry()` returns valid ModuleRegistry object
- ScriptManager-generated scripts no longer fail with "nil value" error
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-register-engine-global/06.1-01-SUMMARY.md`
</output>
