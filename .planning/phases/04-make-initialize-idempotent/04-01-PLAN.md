---
phase: 04-make-initialize-idempotent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/Module.h
  - src/modules/TrackerSequencer.cpp
  - src/modules/MultiSampler.cpp
autonomous: true

must_haves:
  truths:
    - "Second call to initialize() returns immediately without re-subscribing"
    - "Destructor unsubscribes from ALL PatternRuntime events"
    - "Module base class provides isInitialized_ flag for all subclasses"
  artifacts:
    - path: "src/modules/Module.h"
      provides: "isInitialized_ flag in protected section"
      contains: "bool isInitialized_"
    - path: "src/modules/TrackerSequencer.cpp"
      provides: "Idempotent initialize() with complete destructor cleanup"
      contains: "if (isInitialized_) return"
    - path: "src/modules/MultiSampler.cpp"
      provides: "Idempotent initialize()"
      contains: "if (isInitialized_) return"
  key_links:
    - from: "src/modules/TrackerSequencer.cpp"
      to: "src/modules/Module.h"
      via: "inherits isInitialized_ from Module base class"
      pattern: "isInitialized_"
    - from: "src/modules/TrackerSequencer.cpp"
      to: "PatternRuntime events"
      via: "ofRemoveListener in destructor"
      pattern: "sequencerBindingChangedEvent"
---

<objective>
Add idempotency guards to all module `initialize()` methods to prevent duplicate event subscriptions.

Purpose: Fix edge case where `initialize()` is called during setup AND after session restore, causing duplicate `clock.subscribeToStep()` and PatternRuntime subscriptions.

Output: All module `initialize()` methods guard against double-initialization; TrackerSequencer destructor unsubscribes from ALL events.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-make-initialize-idempotent/04-RESEARCH.md

@src/modules/Module.h
@src/modules/TrackerSequencer.cpp
@src/modules/MultiSampler.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isInitialized_ flag to Module base class</name>
  <files>src/modules/Module.h</files>
  <action>
Add `bool isInitialized_ = false;` to the protected section of Module class.

Location: After line 901 (`std::atomic<bool> enabled_{true};`) and before line 905 (`std::string instanceName_;`).

Add this line with a comment:
```cpp
bool isInitialized_ = false;  // Prevents duplicate initialization in derived classes
```

This provides a consistent idempotency flag for all Module subclasses.
  </action>
  <verify>
`grep -n "isInitialized_" src/modules/Module.h` shows the new flag in protected section.
  </verify>
  <done>
Module.h has `bool isInitialized_ = false;` in protected section, usable by all derived classes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make TrackerSequencer::initialize() idempotent and fix destructor</name>
  <files>src/modules/TrackerSequencer.cpp</files>
  <action>
Two changes required:

**1. Add guard at top of initialize() (line 72):**
After the method signature opening brace, add:
```cpp
    // Idempotency guard - prevent duplicate subscriptions on second call
    if (isInitialized_) return;
```

**2. Add flag at end of initialize() (line 248, before closing brace):**
```cpp
    isInitialized_ = true;
```

**3. Fix destructor to unsubscribe from ALL PatternRuntime events (line 35):**
The current destructor at lines 30-36 is MISSING unsubscribe for `sequencerBindingChangedEvent`.

Change destructor to:
```cpp
TrackerSequencer::~TrackerSequencer() {
    // Unsubscribe from ALL PatternRuntime events
    if (patternRuntime_) {
        ofRemoveListener(patternRuntime_->triggerEvent, this, &TrackerSequencer::onPatternRuntimeTrigger);
        ofRemoveListener(patternRuntime_->patternDeletedEvent, this, &TrackerSequencer::onPatternDeleted);
        ofRemoveListener(patternRuntime_->sequencerBindingChangedEvent, this, &TrackerSequencer::onSequencerBindingChanged);
    }
}
```

WHY: Line 188 subscribes to `sequencerBindingChangedEvent` but destructor doesn't unsubscribe, causing dangling listener.
  </action>
  <verify>
1. `grep -n "if (isInitialized_) return" src/modules/TrackerSequencer.cpp` shows guard in initialize()
2. `grep -n "isInitialized_ = true" src/modules/TrackerSequencer.cpp` shows flag being set
3. `grep -n "sequencerBindingChangedEvent" src/modules/TrackerSequencer.cpp` shows unsubscribe in destructor
  </verify>
  <done>
TrackerSequencer::initialize() is idempotent (early return if already initialized).
TrackerSequencer destructor unsubscribes from triggerEvent, patternDeletedEvent, AND sequencerBindingChangedEvent.
  </done>
</task>

<task type="auto">
  <name>Task 3: Make MultiSampler::initialize() idempotent</name>
  <files>src/modules/MultiSampler.cpp</files>
  <action>
Add idempotency guard to MultiSampler::initialize() for consistency.

**1. Add guard at top of initialize() (line 579, after the opening brace):**
```cpp
    // Idempotency guard - prevent duplicate initialization
    if (isInitialized_) return;
```

**2. Add flag at end of initialize() (line 606, before closing brace):**
```cpp
    isInitialized_ = true;
```

NOTE: MultiSampler::initialize() doesn't have event subscriptions, but adding the guard:
- Prevents redundant preloadAllSamples() calls
- Ensures consistency across all modules
- Future-proofs against subscription additions
  </action>
  <verify>
1. `grep -n "if (isInitialized_) return" src/modules/MultiSampler.cpp` shows guard in initialize()
2. `grep -n "isInitialized_ = true" src/modules/MultiSampler.cpp` shows flag being set
  </verify>
  <done>
MultiSampler::initialize() is idempotent (early return if already initialized).
  </done>
</task>

</tasks>

<verification>
1. Build verification: `make -j8` (or project build command) completes without errors
2. All three modules compile with the isInitialized_ flag from base class
3. No duplicate subscription warnings in logs during session restore
</verification>

<success_criteria>
- Module.h has `isInitialized_` flag in protected section
- TrackerSequencer::initialize() guards with `if (isInitialized_) return;` at top
- TrackerSequencer destructor unsubscribes from ALL 3 PatternRuntime events
- MultiSampler::initialize() guards with `if (isInitialized_) return;` at top
- Project builds successfully with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-make-initialize-idempotent/04-01-SUMMARY.md`
</output>
