---
phase: 7.10.1-simplify-scriptmanager
plan: 01
type: execute
---

<objective>
Simplify ScriptManager by removing deferred update mechanisms and implementing a single atomic state machine for update coordination.

Purpose: Eliminate 3 layers of deferred updates that create timing windows, replacing with a single atomic guard that prevents concurrent updates.
Output: Simplified ScriptManager.h/.cpp with atomic UpdateState enum, no DeferredUpdate struct, no deferred update logic.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
~/.config/opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-02-SCRIPTMANAGER-AUDIT.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-05-OVERCOMPLEXIFICATIONS.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-06-SIMPLIFIED-DESIGN.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-07-IMPLEMENTATION-PLAN.md
@src/core/ScriptManager.h
@src/core/ScriptManager.cpp

**Tech stack available:**
- std::atomic for lock-free coordination
- UpdateState enum (IDLE/UPDATING) - to be added
- Observer subscription pattern - already established

**Established patterns:**
- Shell subscription infrastructure (Phase 7.8)
- State snapshots for thread-safe reads
- Atomic state version tracking

**Constraining decisions:**
- Phase 7.10: Remove all 3 deferred update layers
- Phase 7.10: Use single atomic state machine instead of 4 nested guards
- Phase 7.10: No background script execution thread

**Key files:**
- `src/core/ScriptManager.h` - Header to simplify
- `src/core/ScriptManager.cpp` - Implementation to simplify

**Issues being addressed:**
- OVERCOMPLEXIFICATION #1: 3 deferred update layers creating timing windows
- OVERCOMPLEXIFICATION #2: 4 nested guard checks in ScriptManager
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify ScriptManager Header</name>
  <files>src/core/ScriptManager.h</files>
  <action>
Remove the DeferredUpdate struct (lines 92-100), remove deferredUpdates_ member and applyDeferredUpdates() declaration, remove lastRegeneratedVersion_, and add new UpdateState enum with IDLE/UPDATING states and atomic updateState_ member.

New ScriptManager.h private section should contain:
- Engine* engine_ = nullptr
- size_t observerId_ = 0
- std::string currentScript_
- std::function<void(const std::string&)> updateCallback_
- enum class UpdateState { IDLE, UPDATING }
- std::atomic<UpdateState> updateState_{UpdateState::IDLE}
  </action>
  <verify>grep -n "DeferredUpdate" src/core/ScriptManager.h returns no matches && grep -n "UpdateState" src/core/ScriptManager.h shows new enum</verify>
  <done>ScriptManager.h has UpdateState enum, no DeferredUpdate struct, no deferredUpdates_ member</done>
</task>

<task type="auto">
  <name>Task 2: Simplify ScriptManager Implementation</name>
  <files>src/core/ScriptManager.cpp</files>
  <action>
Simplify the observer callback in setup() to use atomic state machine instead of deferred updates:

1. Replace the 4-nested-guard callback with single atomic compare_exchange_strong:
   - Check if updateState_ == IDLE
   - If yes, atomically swap to UPDATING, run updateScriptFromState(), reset to IDLE
   - If no (already UPDATING), skip this update (state already changed)

2. Simplify updateScriptFromState():
   - Remove 4 nested guard checks
   - Use single state.version directly
   - Generate script, set currentScript_, notify callback

3. Remove applyDeferredUpdates() entirely

4. Remove empty logging blocks (lines 72-73, 78-79)

5. Remove any "CRITICAL FIX" comments
  </action>
  <verify>grep -n "deferredUpdates_" src/core/ScriptManager.cpp returns no matches && grep -n "applyDeferredUpdates" src/core/ScriptManager.cpp returns no matches</verify>
  <done>ScriptManager.cpp has no deferred update logic, no applyDeferredUpdates method, simplified callback with single atomic guard</done>
</task>

</tasks>

<verification>
- [ ] `xcodebuild -project videoTracker.xcodeproj -scheme videoTracker build 2>&1 | tail -20` succeeds without ScriptManager errors
- [ ] ScriptManager unit tests pass (if they exist)
- [ ] No "CRITICAL FIX" comments remain in ScriptManager files
</verification>

<success_criteria>

- Task 1 complete: ScriptManager.h has UpdateState enum, no DeferredUpdate struct
- Task 2 complete: ScriptManager.cpp has simplified callback with atomic state machine
- No deferred update mechanisms remain in ScriptManager
- Single atomic guard replaces 4 nested guards
- Code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/7.10.1-simplify-scriptmanager/7.10.1-01-SUMMARY.md` following the summary template.
</output>
