---
phase: 7.10.1-simplify-scriptmanager
plan: 02
type: execute
---

<objective>
Simplify CodeShell by reducing EditorMode from 3 to 2 states and removing duplicate local flags.

Purpose: Eliminate redundant state tracking (isExecutingScript_) and LOCKED mode that provides no additional safety over EDIT mode.
Output: Simplified CodeShell.h/.cpp with EditorMode (VIEW, EDIT only), no isExecutingScript_ atomic, simplified callback registration.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
~/.config/opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-03-CODESHELL-AUDIT.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-05-OVERCOMPLEXIFICATIONS.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-06-SIMPLIFIED-DESIGN.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-07-IMPLEMENTATION-PLAN.md
@src/shell/CodeShell.h
@src/shell/CodeShell.cpp

**Tech stack available:**
- EditorMode enum - to be simplified
- Engine unsafe state flags - already established
- State snapshots for thread-safe reads

**Established patterns:**
- Shell subscription infrastructure (Phase 7.8)
- Engine unsafe state tracking (Phase 7.9)

**Constraining decisions:**
- Phase 7.10: Reduce EditorMode from 3 to 2 states
- Phase 7.10: Trust Engine's unsafeStateFlags_ instead of duplicate local flags
- Phase 7.10: Single update path in callback

**Key files:**
- `src/shell/CodeShell.h` - Header to simplify
- `src/shell/CodeShell.cpp` - Implementation to simplify

**Issues being addressed:**
- OVERCOMPLEXIFICATION #5: EditorMode 3 states (VIEW, EDIT, LOCKED) → 2 states
- OVERCOMPLEXIFICATION #6: Duplicate isExecutingScript_ flag between CodeShell and Engine
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify CodeShell Header</name>
  <files>src/shell/CodeShell.h</files>
  <action>
Change EditorMode enum from 3 states to 2 states (remove LOCKED):
```cpp
enum class EditorMode { VIEW, EDIT };
// LOCKED removed - EDIT mode already prevents auto-updates
```

Remove isExecutingScript_ atomic member (line 93) - CodeShell should trust Engine's unsafeStateFlags_ instead.
  </action>
  <verify>grep -n "EditorMode" src/shell/CodeShell.h | grep -c "LOCKED" == 0 && grep -n "isExecutingScript_" src/shell/CodeShell.h returns no matches</verify>
  <done>CodeShell.h has EditorMode with VIEW/EDIT only, no isExecutingScript_ atomic member</done>
</task>

<task type="auto">
  <name>Task 2: Simplify CodeShell Implementation</name>
  <files>src/shell/CodeShell.cpp</files>
  <action>
Simplify the script update callback and related methods:

1. Simplify setScriptUpdateCallback():
   - Remove isExecutingScript_ checks
   - Remove hasPendingScriptUpdate_ logic for script execution
   - Only check editorMode_ == EDIT to skip updates
   - In VIEW mode, apply update directly

2. Simplify update() method:
   - Remove isExecutingScript_ local flag checks
   - Keep only engine_->isExecutingScript() check via Engine's unsafe state
   - Trust Engine's unsafeStateFlags_ for safety

3. Remove syncedScript_ buffer (used as second deferred buffer)

4. Remove signal handlers (lines 26-53) or move to separate debugging file

5. Clean up mode transition comments
  </action>
  <verify>grep -n "syncedScript_" src/shell/CodeShell.cpp returns no matches && grep -c "isExecutingScript_" src/shell/CodeShell.cpp == 0</verify>
  <done>CodeShell.cpp has simplified callback, no syncedScript_ buffer, no isExecutingScript_ usage, signal handlers removed or moved</done>
</task>

</tasks>

<verification>
- [ ] `xcodebuild -project videoTracker.xcodeproj -scheme videoTracker build 2>&1 | tail -20` succeeds without CodeShell errors
- [ ] CodeShell tests pass (if they exist)
- [ ] Editor mode transitions work (VIEW ↔ EDIT)
</verification>

<success_criteria>

- Task 1 complete: EditorMode has 2 states, no isExecutingScript_ in header
- Task 2 complete: Simplified callback, no syncedScript_, no isExecutingScript_ usage
- Code compiles without errors
- Editor mode transitions work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/7.10.1-simplify-scriptmanager/7.10.1-02-SUMMARY.md` following the summary template.
</output>
