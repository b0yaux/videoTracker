---
phase: 7.10.1-simplify-scriptmanager
plan: 03
type: execute
---

<objective>
Remove background script execution thread and async infrastructure from Engine, then consolidate mutexes.

Purpose: Eliminate unnecessary async complexity - synchronous script execution is safer and simpler. Consolidate duplicate synchronization primitives.
Output: Simplified Engine.h/.cpp with no scriptExecutionThread_, no asyncLua_, no scriptExecutionQueue_, and no scriptExecutionMutex_.
</objective>

<execution_context>
~/.config/opencode/get-shit-done/workflows/execute-phase.md
./summary.md
~/.config/opencode/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-04-ENGINE-AUDIT.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-05-OVERCOMPLEXIFICATIONS.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-06-SIMPLIFIED-DESIGN.md
@.planning/phases/7.10-audit-simplify-scriptmanager/7.10-07-IMPLEMENTATION-PLAN.md
@src/core/Engine.h
@src/core/Engine.cpp

**Tech stack available:**
- std::thread for background threads - to be removed
- moodycamel::BlockingConcurrentQueue - to be removed from script execution
- lua_ (main Lua state) - already exists

**Established patterns:**
- Synchronous command execution via command queue
- State snapshots for thread-safe reads
- Atomic unsafe state flags

**Constraining decisions:**
- Phase 7.10: Remove background script execution thread
- Phase 7.10: Use synchronous execution only (eval() without async)
- Phase 7.10: Consolidate synchronization to unsafeStateFlags_

**Key files:**
- `src/core/Engine.h` - Remove async infrastructure, consolidate mutexes
- `src/core/Engine.cpp` - Remove async methods, simplify eval()

**Issues being addressed:**
- OVERCOMPLEXIFICATION #8: Background script execution thread unnecessary
- OVERCOMPLEXIFICATION #9: Multiple synchronization primitives for same purpose
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Async Script Execution from Engine</name>
  <files>src/core/Engine.h, src/core/Engine.cpp</files>
  <action>
Remove async script execution infrastructure:

From Engine.h, remove:
- scriptExecutionThread_ (line ~615)
- asyncLua_ (line ~563)
- scriptExecutionQueue_ (line ~630)
- pendingScriptCallbacks_ (line ~638)
- scriptExecutionThreadRunning_ (line ~616-618)
- nextScriptExecutionId_ (line ~618)
- executeScriptInBackground() declaration
- scriptExecutionThreadFunction() declaration

From Engine.cpp, remove:
- scriptExecutionThreadFunction() entire method
- executeScriptInBackground() entire method

Simplify eval() to synchronous execution only:
```cpp
Engine::Result Engine::eval(const std::string& script) {
    Result result;
    if (lua_->eval(script)) {
        result.success = true;
        result.message = "OK";
    } else {
        result.success = false;
        result.error = lua_->getLastError();
    }
    return result;
}
```
  </action>
  <verify>grep -n "scriptExecutionThread" src/core/Engine.h | wc -l == 0 && grep -n "executeScriptInBackground" src/core/Engine.cpp | wc -l == 0 && grep -n "asyncLua_" src/core/Engine.h | wc -l == 0</verify>
  <done>Engine.h has no scriptExecutionThread, asyncLua, scriptExecutionQueue, executeScriptInBackground. Engine.cpp has simplified eval(), no executeScriptInBackground, no scriptExecutionThreadFunction</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate Engine Mutexes</name>
  <files>src/core/Engine.h</files>
  <action>
Remove scriptExecutionMutex_ (marked TODO in audit) since unsafeStateFlags_ already provides the safety check that mutex was providing.

From Engine.h, remove:
- scriptExecutionMutex_ (line ~613)
  </action>
  <verify>grep -n "scriptExecutionMutex_" src/core/Engine.h | wc -l == 0</verify>
  <done>Engine.h has no scriptExecutionMutex_</done>
</task>

</tasks>

<verification>
- [ ] `xcodebuild -project videoTracker.xcodeproj -scheme videoTracker build 2>&1 | tail -20` succeeds without Engine errors
- [ ] Script execution still works (synchronous)
- [ ] No async-related crashes or race conditions
</verification>

<success_criteria>

- Task 1 complete: No background script execution thread, no async infrastructure
- Task 2 complete: No scriptExecutionMutex_
- Code compiles without errors
- Synchronous script execution works
</success_criteria>

<output>
After completion, create `.planning/phases/7.10.1-simplify-scriptmanager/7.10.1-03-SUMMARY.md` following the summary template.
</output>
