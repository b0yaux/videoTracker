---
phase: 7.9.2-address-substantial-issues-in-scripting-system
plan: 7.9.2-05-FIX
type: fix
---

<objective>
Fix 5 critical issues from Issue #1 deep analysis (scripting and state synchronization).

Source: .planning/ISSUE_1_DEEP_ANALYSIS.md
Priority: Issue 1.1 (callback use-after-free) is CRITICAL - causes malloc crashes
Issues: 5 total (1 critical, 4 high)
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-phase.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/ISSUES.md
@.planning/ISSUE_1_DEEP_ANALYSIS.md

**Issues being fixed:**
- Issue 1.1: Callback Never Unregistered (CRITICAL - Primary Crash Cause)
- Issue 1.2: Stale Script in State Snapshots
- Issue 1.3: Deferred Updates Lost After 60 Frames
- Issue 1.4: Redundant Update Paths
- Issue 1.5: Unsafe State Flag Blocking

**Deep analysis findings:**
- malloc corruption crashes from dangling callback pointer
- Script updates lost during script execution
- Conflicting update paths (callback vs onStateChanged)
- State version mismatches causing sync failures

**Files to modify:**
- src/core/ScriptManager.h/.cpp
- src/core/Engine.h/.cpp
- src/shell/CodeShell.h/.cpp
</context>

<tasks>

<task type="auto">
  <name>Fix 1.1: Add callback unregistration to prevent use-after-free crash</name>
  <files>apps/myApps/videoTracker/src/core/ScriptManager.h, apps/myApps/videoTracker/src/core/ScriptManager.cpp, apps/myApps/videoTracker/src/core/Engine.h, apps/myApps/videoTracker/src/core/Engine.cpp, apps/myApps/videoTracker/src/shell/CodeShell.cpp</files>
  <action>
Implement proper callback cleanup to prevent use-after-free crashes:

**ScriptManager.h:**
- Add declaration: `void clearScriptUpdateCallback();`

**ScriptManager.cpp:**
- Implement `clearScriptUpdateCallback()` that sets `updateCallback_ = nullptr`

**Engine.h:**
- Add to Shell-safe API: `void clearScriptUpdateCallback();`

**Engine.cpp:**
- Implement `clearScriptUpdateCallback()` that delegates to `scriptManager_.clearScriptUpdateCallback()`

**CodeShell.cpp:**
- In `exit()` method, call `engine_->clearScriptUpdateCallback()` before other cleanup
- This ensures the callback is unregistered before CodeShell destruction

This fix addresses the primary crash cause: dangling callback pointer that outlives CodeShell object.
  </action>
  <verify>
grep -n "clearScriptUpdateCallback" apps/myApps/videoTracker/src/core/ScriptManager.* apps/myApps/videoTracker/src/core/Engine.* apps/myApps/videoTracker/src/shell/CodeShell.cpp shows implementation
CodeShell::exit() calls clearScriptUpdateCallback() before other cleanup
  </verify>
  <done>Callback unregistration implemented, use-after-free crash prevented</done>
</task>

<task type="auto">
  <name>Fix 1.2: Use callback as single source of truth for script updates</name>
  <files>apps/myApps/videoTracker/src/shell/CodeShell.cpp</files>
  <action>
Eliminate redundant update path (onStateChanged) that conflicts with callback:

**CodeShell.cpp:**
1. Modify `onStateChanged()` to NOT directly update `pendingScriptUpdate_` from `state.script.currentScript`
2. Instead, the callback should be the only source of fresh script updates
3. Keep `onStateChanged()` for other state changes (GUI updates, etc.) but remove script-specific handling

**Rationale:**
- The callback receives fresh script directly from ScriptManager
- `state.script.currentScript` can be stale (cached at snapshot time)
- Having two update paths causes conflicts and update loss

This ensures script updates always come from the callback (fresh), not from potentially stale state snapshots.
  </action>
  <verify>
grep -n "onStateChanged" apps/myApps/videoTracker/src/shell/CodeShell.cpp shows no direct pendingScriptUpdate_ assignment from state.script.currentScript
Script updates only via callback mechanism
  </verify>
  <done>Single update path established, stale script conflicts eliminated</done>
</task>

<task type="auto">
  <name>Fix 1.3: Remove 60-frame timeout for deferred updates</name>
  <files>apps/myApps/videoTracker/src/shell/CodeShell.cpp</files>
  <action>
Replace fragile timeout mechanism with robust state version tracking:

**CodeShell.cpp:**
1. Remove the `pendingFrames > 60` logic that clears `hasPendingScriptUpdate_`
2. Instead, use state version comparison to detect when update is safe:
   - Keep `hasPendingScriptUpdate_` flag set until update is safely applied
   - In `update()`, check: `if (hasPendingScriptUpdate_ && engine_->getStateVersion() > lastProcessedVersion_)`
   - Only clear flag after successful update

3. Add explicit retry mechanism:
   - After script execution completes, trigger re-check of pending updates
   - Use state version to confirm update is fresh before applying

This prevents updates from being lost when script execution takes >1 second.
  </action>
  <verify>
grep -n "pendingFrames" apps/myApps/videoTracker/src/shell/CodeShell.cpp returns no matches
Pending updates persist until safely applied (verified via state version check)
  </verify>
  <done>Updates no longer lost during long script executions</done>
</task>

<task type="auto">
  <name>Fix 1.4: Eliminate redundant update path completely</name>
  <files>apps/myApps/videoTracker/src/shell/CodeShell.cpp, apps/myApps/videoTracker/src/core/ScriptManager.cpp</files>
  <action>
Ensure only one script update path exists:

**CodeShell.cpp:**
1. Remove script-related handling from `onStateChanged()` entirely
2. Keep `onStateChanged()` for non-script state changes (module changes, connections, etc.)
3. All script updates come through the callback path only

**ScriptManager.cpp:**
1. Ensure `updateCallback_` is called whenever `currentScript_` changes
2. This is the single source of truth for script updates

**Verification:**
- Verify `onStateChanged()` no longer touches `pendingScriptUpdate_` or `hasPendingScriptUpdate_`
- Verify callback is called for ALL script changes (generation, execution, etc.)
  </action>
  <verify>
CodeShell::onStateChanged() has no references to pendingScriptUpdate_ or hasPendingScriptUpdate_
ScriptManager calls updateCallback_ for all script changes
  </verify>
  <done>Single update path enforced, no more conflicts</done>
</task>

<task type="auto">
  <name>Fix 1.5: Improve update timing with state version verification</name>
  <files>apps/myApps/videoTracker/src/shell/CodeShell.cpp, apps/myApps/videoTracker/src/core/Engine.h</files>
  <action>
Replace unreliable flag checks with robust state version verification:

**CodeShell.cpp:**
1. Replace `engine_->isExecutingScript()` and `engine_->commandsBeingProcessed()` checks
2. Instead, use state version comparison:
   ```cpp
   uint64_t currentVersion = engine_->getStateVersion();
   if (currentVersion > lastAppliedVersion_) {
       // Safe to apply update
       applyPendingScriptUpdate();
       lastAppliedVersion_ = currentVersion;
   }
   ```

3. Track `lastAppliedVersion_` member variable

**Benefits:**
- State version increments AFTER commands/scripts complete
- No race condition between unsafe flag and state update
- More reliable than arbitrary timeout or flag polling

This ensures updates are applied exactly once, when state is truly consistent.
  </action>
  <verify>
grep -n "lastAppliedVersion_" apps/myApps/videoTracker/src/shell/CodeShell.cpp shows member variable
Update timing uses state version comparison instead of unsafe state flags
  </verify>
  <done>Updates applied only when state is consistent, no timing issues</done>
</task>

</tasks>

<verification>
Before declaring fix complete:
- [ ] Issue 1.1 fixed: Callback unregistration prevents use-after-free crashes
- [ ] Issue 1.2 fixed: Single update path prevents stale script conflicts
- [ ] Issue 1.3 fixed: No more lost updates during long script executions
- [ ] Issue 1.4 fixed: Redundant update path eliminated
- [ ] Issue 1.5 fixed: State version verification prevents timing issues
- [ ] malloc corruption crashes eliminated
- [ ] Script synchronization works correctly
</verification>

<success_criteria>
- All 5 issues from ISSUE_1_DEEP_ANALYSIS.md addressed
- malloc corruption crashes (primary symptom) eliminated
- Script updates sync correctly across all shells
- No updates lost during script execution
- No more state version mismatches
</success_criteria>

<output>
After completion, create `.planning/phases/7.9.2-address-substantial-issues-in-scripting-system/7.9.2-05-FIX-SUMMARY.md`
</output>
