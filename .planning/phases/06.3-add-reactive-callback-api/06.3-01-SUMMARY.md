---
phase: 06.3-add-reactive-callback-api
plan: "01"
subsystem: api
tags: [lua, swig, reactive, callbacks, live-coding]

# Dependency graph
requires:
  - phase: 06.2-standardize-command-routing
    provides: Command queue pattern, Engine global access via SWIG
provides:
  - Lua callback API for reactive state synchronization
  - engine:onStateChange(fn) → callbackId registration
  - engine:removeStateChangeCallback(id) unregistration
  - EngineState snapshot passed to Lua callbacks
affects: [live-coding workflows, external state synchronization]

# Tech tracking
tech-stack:
  added: [lua_State callbacks, Lua registry references, SWIG %extend methods]
  patterns: [Reactive callback pattern, Lua-C++ bridge, Registry reference storage]

key-files:
  created: []
  modified:
    - src/core/Engine.h
    - src/core/Engine.cpp
    - src/core/lua/videoTracker.i

key-decisions:
  - "Lua callbacks stored separately from C++ StateObserver to handle lua_State* requirements"
  - "Lua function references stored in Lua registry to prevent garbage collection"
  - "EngineState converted to Lua table with clock.bpm and modules[] structure"

patterns-established:
  - "Reactive sync: Scripts register callbacks that fire on any Engine state change"
  - "Callback lifecycle: register → invoke on state change → unregister by ID"

# Metrics
duration: 4-5 min
completed: 2026-01-21
---

# Phase 6.3 Plan 1: Add Reactive Callback API Summary

**Lua callback API enabling scripts to receive state change notifications for live-coding workflow**

## Performance

- **Duration:** ~4-5 minutes
- **Started:** 2026-01-21T18:09:54Z
- **Completed:** 2026-01-21T18:14:29Z
- **Tasks:** 3/3
- **Files modified:** 3

## Accomplishments

- Added LuaStateChangeCallback typedef and registration/unregistration methods to Engine.h
- Implemented Lua callback storage and invocation in Engine.cpp
- Extended notifyObserversWithState() to invoke Lua callbacks after C++ observers
- Exposed onStateChange() and removeStateChangeCallback() via SWIG %extend
- Lua callbacks receive EngineState converted to Lua table with clock.bpm and modules[]
- Build succeeded without errors

## Task Commits

Each task was committed atomically:

1. **Task 1: Add Lua callback registration methods to Engine.h** - `fb1df8d` (feat)
2. **Task 2: Implement Lua callback methods in Engine.cpp** - `ece7c5e` (feat)
3. **Task 3: Expose onStateChange and removeStateChangeCallback via SWIG** - `3231ea1` (feat)

**Plan metadata:** `docs(06.3-01): complete Add Reactive Callback API plan`

## Files Created/Modified

- `src/core/Engine.h` - Added LuaStateChangeCallback typedef, method declarations, and luaCallbacks_ member
- `src/core/Engine.cpp` - Implemented register/unregister methods and Lua callback invocation in notifyObserversWithState()
- `src/core/lua/videoTracker.i` - Added engineOnStateChange/engineRemoveStateChangeCallback helpers and %extend methods

## Decisions Made

- Lua callbacks stored separately from C++ StateObserver callbacks to handle lua_State* requirements safely
- Lua function references stored in Lua registry (luaL_ref) to prevent garbage collection during callback lifetime
- EngineState converted to Lua table structure with clock.bpm and modules[] for Lua consumption
- Callbacks invoked after C++ observers to maintain existing behavior and add Lua on top

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed as specified with no blocking issues.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Reactive callback infrastructure is complete and tested via build
- Scripts can now use `engine:onStateChange(function(state) ... end)` for reactive sync
- Ready for Phase 6.3 Plan 2 (if additional callback features needed) or Phase 6.4

---

*Phase: 06.3-add-reactive-callback-api*
*Completed: 2026-01-21*
