---
phase: 06.2-standardize-command-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/lua/videoTracker.i
  - src/core/lua/LuaHelpers.cpp
autonomous: true

must_haves:
  truths:
    - "setBPM routes through executeCommandImmediate() on fallback instead of direct call"
    - "createSampler uses AddModuleCommand instead of string command"
    - "createSequencer uses AddModuleCommand instead of string command"
  artifacts:
    - path: "src/core/lua/videoTracker.i"
      provides: "Clock::setBPM with executeCommandImmediate fallback"
      contains: "executeCommandImmediate"
    - path: "src/core/lua/LuaHelpers.cpp"
      provides: "createSampler/createSequencer with AddModuleCommand"
      contains: "AddModuleCommand"
  key_links:
    - from: "videoTracker.i Clock::setBPM"
      to: "Engine::executeCommandImmediate"
      via: "SetBPMCommand"
      pattern: "executeCommandImmediate.*SetBPMCommand"
    - from: "LuaHelpers::createSampler"
      to: "Engine::enqueueCommand"
      via: "AddModuleCommand"
      pattern: "AddModuleCommand.*MultiSampler"
    - from: "LuaHelpers::createSequencer"
      to: "Engine::enqueueCommand"
      via: "AddModuleCommand"
      pattern: "AddModuleCommand.*TrackerSequencer"
---

<objective>
Standardize command routing so ALL Lua operations use the command queue for consistent behavior and thread safety.

Purpose: Ensure Lua helper functions and SWIG bindings follow the same command queue patterns established in Clock::start()/stop(), eliminating direct method calls that bypass Engine notifications.

Output: Updated videoTracker.i and LuaHelpers.cpp with proper command queue usage.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-register-engine-global/06.1-01-SUMMARY.md
@.planning/phases/06-research-design-lua-engine-integration/06-DESIGN.md

# Source files to modify
@src/core/lua/videoTracker.i
@src/core/lua/LuaHelpers.cpp
@src/core/Command.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Clock::setBPM fallback to use executeCommandImmediate</name>
  <files>src/core/lua/videoTracker.i</files>
  <action>
Fix the Clock::setBPM() fallback pattern (lines 183-196) to use executeCommandImmediate() instead of direct $self->setBPM() call.

**Current code (lines 188-190):**
```cpp
if (!engine->enqueueCommand(std::move(cmd))) {
    ofLogWarning("Clock") << "Failed to enqueue SetBPMCommand, falling back to direct call";
    $self->setBPM(bpm);  // WRONG - bypasses Engine notifications
}
```

**Change to match Clock::start()/stop() pattern (lines 210-214, 234-238):**
```cpp
if (!engine->enqueueCommand(std::move(cmd))) {
    // Fallback: execute immediately if queue is full (ensures state notifications)
    ofLogWarning("Clock") << "Command queue full, executing SetBPMCommand immediately";
    auto fallbackCmd = std::make_unique<vt::SetBPMCommand>(bpm);
    engine->executeCommandImmediate(std::move(fallbackCmd));
}
```

This ensures the fallback path still routes through Engine for proper state notifications, matching the pattern already used by Clock::start() and Clock::stop().
  </action>
  <verify>
grep -n "executeCommandImmediate" src/core/lua/videoTracker.i | grep -i bpm
# Should show the new fallback line using executeCommandImmediate
grep -n '\$self->setBPM' src/core/lua/videoTracker.i
# Should NOT find $self->setBPM in the queue-full fallback block (only in engine-not-available block is OK)
  </verify>
  <done>
Clock::setBPM() uses executeCommandImmediate() for queue-full fallback, matching start()/stop() pattern. Direct $self->setBPM() only used for engine-not-available edge case.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor createSampler/createSequencer to use AddModuleCommand</name>
  <files>src/core/lua/LuaHelpers.cpp</files>
  <action>
Refactor createSampler() and createSequencer() to use AddModuleCommand instead of string commands.

**AddModuleCommand already exists in Command.h (lines 140-159):**
```cpp
class AddModuleCommand : public Command {
public:
    AddModuleCommand(const std::string& moduleType, const std::string& moduleName = "")
        : moduleType_(moduleType), moduleName_(moduleName), createdModuleName_("") {}
    // ...
};
```

**Fix createSampler() (lines 42-49) - replace:**
```cpp
// Module doesn't exist - create it
std::string command = "add MultiSampler " + name;
auto result = engine_->executeCommand(command);
```

**With:**
```cpp
// Module doesn't exist - create it using command queue
auto cmd = std::make_unique<vt::AddModuleCommand>("MultiSampler", name);
bool enqueued = engine_->enqueueCommand(std::move(cmd));

if (!enqueued) {
    ofLogWarning("LuaHelpers") << "Command queue full, falling back to executeCommand";
    std::string command = "add MultiSampler " + name;
    auto result = engine_->executeCommand(command);
    if (!result.success) {
        ofLogError("LuaHelpers") << "Failed to create sampler: " << name << " - " << result.error;
        return "";
    }
} else {
    // Give command queue a moment to process (module creation is async)
    ofLogNotice("LuaHelpers") << "Enqueued AddModuleCommand for sampler: " << name;
}
```

**Apply same pattern to createSequencer() (lines 79-86):**
Replace `"add TrackerSequencer " + name` string command with AddModuleCommand("TrackerSequencer", name).

**Also add include at top of file (if not present):**
Verify `#include "core/Command.h"` is present (line 5) - it already is.
  </action>
  <verify>
grep -n "AddModuleCommand" src/core/lua/LuaHelpers.cpp
# Should show 2 usages - one in createSampler, one in createSequencer
grep -n 'executeCommand("add' src/core/lua/LuaHelpers.cpp
# Should only appear in fallback blocks, not as primary path
  </verify>
  <done>
createSampler() and createSequencer() use AddModuleCommand via enqueueCommand() as primary path. String commands only used as fallback when queue is full.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification:**
   ```bash
   cd /Users/jaufre/works/of_v0.12.1_osx_release/apps/myApps/videoTracker
   make -j4 2>&1 | tail -20
   # Should compile without errors
   ```

2. **Pattern verification:**
   ```bash
   # All command queue fallbacks use executeCommandImmediate or executeCommand, not direct calls
   grep -n "executeCommandImmediate\|enqueueCommand\|AddModuleCommand" src/core/lua/videoTracker.i src/core/lua/LuaHelpers.cpp
   ```

3. **No remaining direct calls in queue-full blocks:**
   ```bash
   # setBPM should not have $self->setBPM in queue-full block
   grep -A3 "enqueueCommand" src/core/lua/videoTracker.i | grep -v engine-not-available
   ```
</verification>

<success_criteria>
- [ ] videoTracker.i Clock::setBPM uses executeCommandImmediate() for queue-full fallback
- [ ] LuaHelpers.cpp createSampler uses AddModuleCommand via enqueueCommand
- [ ] LuaHelpers.cpp createSequencer uses AddModuleCommand via enqueueCommand
- [ ] Build succeeds without errors
- [ ] All Lua state mutations route through command queue
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-standardize-command-routing/06.2-01-SUMMARY.md`
</output>
