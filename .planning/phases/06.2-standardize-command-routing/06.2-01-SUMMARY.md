---
phase: 06.2-standardize-command-routing
plan: 01
subsystem: lua-integration
tags: [lua, command-queue, thread-safety, videoTracker.i, LuaHelpers]
completed: 2026-01-21

dependency-graph:
  requires: 06.1-register-engine-global
  provides: standardized-command-routing
  affects: 06.3-callback-system

tech-stack:
  added: []
  patterns:
    - command-queue-fallback-pattern
    - executeCommandImmediate-for-thread-safety

key-files:
  created: []
  modified:
    - src/core/lua/videoTracker.i
    - src/core/lua/LuaHelpers.cpp

metrics:
  duration: ~4 minutes
  tasks-completed: 2/2
  build-status: success
---

# Phase 6.2 Plan 1: Standardize Command Routing Summary

Standardized command routing so ALL Lua operations use the command queue for consistent behavior and thread safety.

## Execution Summary

Both tasks executed successfully:
- **Task 1:** Fixed Clock::setBPM fallback to use executeCommandImmediate
- **Task 2:** Refactored createSampler/createSequencer to use AddModuleCommand

**Build:** ✅ Successful (no errors)

## Key Truths Established

1. `setBPM routes through executeCommandImmediate() on fallback instead of direct call`
2. `createSampler uses AddModuleCommand instead of string command`
3. `createSequencer uses AddModuleCommand instead of string command`

## Changes Made

### Task 1: Fix Clock::setBPM Fallback (videoTracker.i)

**Before:**
```cpp
if (!engine->enqueueCommand(std::move(cmd))) {
    ofLogWarning("Clock") << "Failed to enqueue SetBPMCommand, falling back to direct call";
    $self->setBPM(bpm);  // WRONG - bypasses Engine notifications
}
```

**After:**
```cpp
if (!engine->enqueueCommand(std::move(cmd))) {
    // Fallback: execute immediately if queue is full (ensures state notifications)
    ofLogWarning("Clock") << "Command queue full, executing SetBPMCommand immediately";
    auto fallbackCmd = std::make_unique<vt::SetBPMCommand>(bpm);
    engine->executeCommandImmediate(std::move(fallbackCmd));
}
```

This now matches the pattern used by Clock::start() and Clock::stop().

### Task 2: Refactor createSampler/createSequencer (LuaHelpers.cpp)

**Before (createSampler):**
```cpp
std::string command = "add MultiSampler " + name;
auto result = engine_->executeCommand(command);
```

**After (createSampler):**
```cpp
auto cmd = std::make_unique<vt::AddModuleCommand>("MultiSampler", name);
bool enqueued = engine_->enqueueCommand(std::move(cmd));

if (!enqueued) {
    ofLogWarning("LuaHelpers") << "Command queue full, falling back to executeCommand";
    std::string command = "add MultiSampler " + name;
    auto result = engine_->executeCommand(command);
    if (!result.success) {
        ofLogError("LuaHelpers") << "Failed to create sampler: " << name << " - " << result.error;
        return "";
    }
} else {
    ofLogNotice("LuaHelpers") << "Enqueued AddModuleCommand for sampler: " << name;
}
```

Same pattern applied to createSequencer with "TrackerSequencer" module type.

## Verification Results

1. **Pattern verification:**
   - `executeCommandImmediate` now used for setBPM fallback (matches start/stop)
   - `AddModuleCommand` used in both createSampler and createSequencer (4 total usages)

2. **Build verification:** ✅ Compiles without errors

3. **No remaining direct calls in queue-full blocks:** ✅ setBPM only uses direct call for engine-not-available edge case

## Decisions Made

| Decision | Rationale | Status |
|----------|-----------|--------|
| Use executeCommandImmediate for setBPM fallback | Ensures state notifications are sent even when queue is full | ✅ Confirmed |
| Use AddModuleCommand in LuaHelpers | Standardizes module creation to match SetParameterCommand pattern | ✅ Confirmed |

## Deviations from Plan

None - plan executed exactly as written.

## Next Steps

**Phase 6.3:** Implement reactive callbacks for live-coding (engine:onStateChange pattern).

---

## Commits

- `02f185b`: fix(06.2-01): use executeCommandImmediate in setBPM fallback
- `937a073`: feat(06.2-01): refactor createSampler/createSequencer to use AddModuleCommand
